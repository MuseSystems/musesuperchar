<package id="musesuperchar"
         name="musesuperchar"
         developer="Muse Systems"
         descrip="A package to provide an enhanced, more broadly functional user defined field functionality."
         version="0.0.3"
         updater="2.2.5">

    <pkgnotes>
        A package to provide an enhanced, more broadly functional user defined field functionality.
    </pkgnotes>
    <prerequisite type="Query"
                name="xTuple ERP version">
        <query>
            WITH version AS (
            SELECT 
                (SELECT substring(fetchMetricText('ServerVersion'),E'^([[:digit:]]+)\..*'))::integer as major_version,
                (SELECT substring(fetchMetricText('ServerVersion'),E'^[[:digit:]]+\.([[:digit:]]+)\..*$'))::integer as minor_version,
                (SELECT substring(fetchMetricText('ServerVersion'),E'^[[:digit:]]+\.[[:digit:]]+\.([[:digit:]]+)'))::integer as patch_version
             )
             SELECT 
                    (major_version = 4 AND minor_version = 10 AND patch_version >= 1)
                OR  (major_version = 4 AND minor_version > 10)
                OR  (major_version > 4)
             FROM version;
        </query>
        <message>
            This package must be installed against xTuple ERP version 4.10.1 or later.  This package has only been tested against version 4.10.1 and may not work in later version without updating.
        </message>
    </prerequisite>
    <prerequisite type="Query"
                   name="Muse Systems xTuple Utilities">
         <query>
                WITH version AS (
                   SELECT 
                       (SELECT substring(pkghead_version,E'^([[:digit:]]+)\..*'))::integer as major_version,
                       (SELECT substring(pkghead_version,E'^[[:digit:]]+\.([[:digit:]]+)\..*$'))::integer as minor_version,
                       (SELECT substring(pkghead_version,E'^[[:digit:]]+\.[[:digit:]]+\.([[:digit:]]+)'))::integer as      patch_version
                    FROM pkghead
                    WHERE pkghead_name = 'musextputils'
                )
                SELECT 
                       (major_version = 2 AND minor_version = 2 AND patch_version >= 0)
                   OR  (major_version = 2 AND minor_version > 2)
                   OR  (major_version > 2)
                FROM version;
         </query>    
         <message>
             This package requires that the Muse Systems xTuple Utilities version 2.2.0 or any higher version 1 series is installed prior to installation of this package.
         </message>
     </prerequisite>
    <loadpriv name="maintainSuperCharateristics" module="Muse Systems Super Characteristics">
        Grants the user the ability to create, remove, or modify super charateristics.  This permission is typically assigned to power users who are capable of managing user defined data. This permission does not confer the ability to create or remove super characteristic groups, but does allow for the management of super characteristic to group assignments.
    </loadpriv>

    <loadpriv name="maintainSuperCharListQuery" module="Muse Systems Super Characteristics">
        Grants a user the ability to maintain combobox/select list queries.  This permission is highly security sensitive as it will allow entry of arbitrary SQL which will be executed in the context of the end user that is making use of such a super characteristic.  As such this permission should only ever be granted to those with a pre-existing high level of trust.  To use this privilege, a user must also have the maintainSuperCharacteristic privilege.
    </loadpriv>
    
    <loadpriv name="maintainSuperCharSysLockRecsManually" module="Muse Systems Super Characteristics">
        Grants the user privileges to user the user interface to manipulate charateristics which are typically only managed via extension packages.  We stronly recommend that this permission not be regularly granted to any users.  The permission is granted only for the purposes of development convenience and emergency system fixes.  This privilege is best thought of as the privilege to break your system. 
    </loadpriv>

    <loadpriv name="maintainSuperCharInternalNames" module="Muse Systems Super Characteristics">
        Grants the user the ability to update "internal" names of Super Characteristic objects that have them.  This is sensitive because internal names may be used in external reporting or programmings and would be broken by ad hoc, ill-considered changes.  Normally, you really want to consider an internal name fixed once it is created (in other words, we recommend not granting this permission to anyone.)
    </loadpriv>

    <loadpriv name="maintainSuperCharEntities" module="Muse Systems Super Characteristics">
        Grants a user the ability to add or remove "entities" as being valid for super characteristics.  An entity is another table within the system.  Note that this is a sensitive permission since removing an entity from recognition also deletes and super characteristic data for that entity.
    </loadpriv>
    
    <loadpriv name="maintainSuperCharGroups" module="Muse Systems Super Characteristics">
        Grants a user the ability to maintain super characteristic groups, specifically creating or deleting groups.
    </loadpriv>
    
    
    <initscript file="database/misc/early_create_musemetrics.sql" />
    <initscript file="database/tables/data_type.init.sql" />
    <initscript file="database/tables/validator_type.init.sql" />
    <initscript file="database/tables/entity.init.sql" />
    <initscript file="database/tables/entity_package.init.sql" />
    <initscript file="database/tables/sc_def.init.sql" />
    <initscript file="database/tables/sc_group.init.sql" />
    <initscript file="database/tables/sc_def_sc_group_ass.init.sql" />
    <initscript file="database/tables/entity_sc_group_ass.init.sql" />
    <initscript file="database/tables/conditional_validation_rule.init.sql" />
    <initscript file="database/views/v_superchar_entities.init.sql" />

    <createfunction file="database/functions/get_sc_table_name.sql" name="get_sc_table_name" />
    <createfunction file="database/functions/is_superchar_table_populated.sql" name="is_superchar_table_populated" />
    <createfunction file="database/triggers/trig_a_id_manage_sc_entity_tables.sql" name="trig_a_id_manage_sc_entity_tables" />
    <createfunction file="database/triggers/trig_a_d_entity_package_manage_entity_syslock.sql" name="trig_a_d_entity_package_manage_entity_syslock" />
    <createfunction file="database/functions/create_entity.sql" name="create_entity" />
    <createfunction file="database/functions/add_group_entity_association.sql" name="add_group_entity_association" />
    <createfunction file="database/functions/delete_group_entity_association.sql" name="delete_group_entity_association" />
    <createfunction file="database/functions/get_superchar_non_overlapping_entities.sql" name="get_superchar_non_overlapping_entities" />
    <createfunction file="database/functions/get_superchar_group_add_violations.sql" name="get_superchar_group_add_violations" />
    <createfunction file="database/functions/get_superchar_group_remove_violations.sql" name="get_superchar_group_remove_violations" />
    <createfunction file="database/functions/get_group_entity_add_violations.sql" name="get_group_entity_add_violations" />
    <createfunction file="database/functions/get_group_entity_remove_violations.sql" name="get_group_entity_remove_violations" />
    <createfunction file="database/functions/get_superchar_delete_violations.sql" name="get_superchar_delete_violations" />
    
    <createfunction file="database/triggers/trig_b_iu_conditional_validation_rule_violation_check.sql" name="trig_b_iu_conditional_validation_rule_violation_check" />
    <createfunction file="database/triggers/trig_b_iud_sc_def_sc_group_ass_violation_check.sql" name="trig_b_iud_sc_def_sc_group_ass_violation_check" />
    <createfunction file="database/triggers/trig_b_iud_entity_sc_group_ass_violation_check.sql" name="trig_b_iud_entity_sc_group_ass_violation_check" />
    
    <createtable file="database/tables/data_type.sql" name="data_type" />
    <createtable file="database/tables/validator_type.sql" name="validator_type" />
    <createtable file="database/tables/entity.sql" name="entity" />
    <createtable file="database/tables/entity_package.sql" name="entity_package" />
    <createtable file="database/tables/sc_def.sql" name="sc_def" />
    <createtable file="database/tables/sc_group.sql" name="sc_group" />
    <createtable file="database/tables/sc_def_sc_group_ass.sql" name="sc_def_sc_group_ass" />
    <createtable file="database/tables/entity_sc_group_ass.sql" name="entity_sc_group_ass" />
    <createtable file="database/tables/conditional_validation_rule.sql" name="conditional_validation_rule" />
    <createview file="database/views/v_superchar_entities.sql" name="v_superchar_entities" />
    
    <loadappui file="client/uiforms/museScGroupMaint.ui" order="20">Muse Systems Super Characteristic Group/Entity Maintenance (setup subform).</loadappui>
    <loadappui file="client/uiforms/museSuperCharMaint.ui" order="20">Muse Systems Super Characteristic Maintenance (setup subform).</loadappui>
    <loadappui file="client/uiforms/museScCreateEntity.ui" order="20">Muse Systems Super Characteristic Create Entities Form</loadappui>
    <loadappui file="client/uiforms/museScCreateGroup.ui" order="20">Muse Systems Super Characteristic Create Groups Form</loadappui>
    <loadappui file="client/uiforms/museScViolationsDialog.ui" order="20">Muse Systems Super Characteristic Validator Violations Dialog</loadappui>
    
    <loadappscript file="client/scripts/libraries/museScEntityData.js" name="museScEntityData" order="10">Muse Systems Super Characteristic Entity Data Library</loadappscript>
    <loadappscript file="client/scripts/libraries/museScGroupData.js" name="museScGroupData" order="10">Muse Systems Super Characteristic Group Data Library</loadappscript>
    <loadappscript file="client/scripts/libraries/museSuperCharData.js" name="museSuperCharData" order="10">Script Description Here</loadappscript>
    <loadappscript file="client/scripts/libraries/museScWidget.js" name="museScWidget" order="10">Muse Systems Super Characteristic Widget Library</loadappscript>
    
    <loadappscript file="client/scripts/forms/setup.js" name="setup" order="10">Muse Systems Super Characteristic; load SuperChar related setup forms into setup main window.</loadappscript>
    <loadappscript file="client/scripts/forms/museScGroupMaint.js" name="museScGroupMaint" order="10">Muse Systems Super Characteristic; load group maintenance backing script.</loadappscript>
    <loadappscript file="client/scripts/forms/museSuperCharMaint.js" name="museSuperCharMaint" order="10">Muse Systems Super Characteristic; load characteristic maintenance form backing script.</loadappscript>
    <loadappscript file="client/scripts/forms/museScCreateEntity.js" name="museScCreateEntity" order="10">Muse Systems Super Characteristic; create entity form backing script.</loadappscript>
    <loadappscript file="client/scripts/forms/museScCreateGroup.js" name="museScCreateGroup" order="10">Muse Systems Super Characteristic; create group form backing script.</loadappscript>
    
    <finalscript file="database/misc/data_types_seed_data.sql" />
    <finalscript file="database/misc/validator_types_seed_data.sql" />
    <finalscript file="database/misc/entities_seed_data.sql" />
    
</package>